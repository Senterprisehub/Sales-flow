<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Flow</title>
    <!-- Load Tailwind CSS from CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles for the single light theme using CSS variables */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            /* Light Theme Variables */
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --card-bg: #fff;
            --border-color: #e2e8f0;
            --shadow-color: rgba(100, 116, 139, 0.1); /* Slate-500 with opacity */
            --primary-color: #4f46e5;
            --secondary-color: #64748b;
            --accent-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            padding: 1rem;
        }

        .container {
            width: 100%;
            max-width: 1200px; /* Increased for better layout */
            margin: 0 auto;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 1rem;
            box-shadow: 0 4px 6px var(--shadow-color);
            padding: 1.5rem; /* Mobile-first padding */
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        @media (min-width: 640px) {
            .card {
                padding: 2rem;
            }
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            transition: all 0.2s ease-in-out;
            outline: none;
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px var(--shadow-color);
            transform: scale(1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }

        .btn-secondary {
            background-color: var(--border-color);
            color: var(--secondary-color);
            border: 1px solid var(--border-color);
        }
        
        .btn-tertiary {
            background-color: transparent;
            color: var(--secondary-color);
            border: 1px solid var(--border-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
            border: none;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
            border: none;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
            border: none;
        }

        .table-header {
            background-color: var(--border-color);
            font-weight: 600;
        }

        .data-table-container {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 15px var(--shadow-color);
            animation: fadeIn 0.3s ease-out;
            border: 1px solid var(--border-color);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary-color);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-item-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
        
        .manual-content h4 {
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Chart container */
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 1.5rem;
        }
        
        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        @media (min-width: 640px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .stat-card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1.25rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--secondary-color);
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Action buttons in table */
        .action-btn {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            margin-right: 0.25rem;
        }
        
        /* Filter chips */
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .filter-chip {
            background-color: var(--border-color);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .filter-chip-remove {
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            line-height: 1;
        }
    </style>
</head>
<body>

    <!-- Main container for the application -->
    <div class="container">

        <!-- Application Header -->
        <header class="text-center my-8">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-4 sm:space-y-0">
                <button id="manual-btn" class="btn btn-secondary px-4 py-2 text-sm w-full sm:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Manual
                </button>
                <h1 class="text-3xl sm:text-4xl font-bold text-[color:var(--text-color)] text-center w-full sm:w-auto">Sales Flow</h1>
                <!-- Added Sub Heading -->
                <p class="mt-1 mb-1 text-sm font-semibold text-[color:var(--secondary-color)]">Developed By S R Software Studio</p>
                <!-- Dummy button to reveal "Delete All" button for safety -->
                <button id="dummy-delete-btn" class="btn btn-tertiary px-4 py-2 text-sm w-full sm:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Reset Data
                </button>
            </div>
            <p class="mt-1 text-sm text-[color:var(--secondary-color)]">Track and analyze your sales targets.</p>
        </header>

        <!-- Main grid layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left column for input and management -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Add New Entry Card -->
                <div class="card">
                    <h2 class="text-lg sm:text-xl font-bold mb-6">Add New Entry</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <input type="text" id="party" placeholder="Party Name" list="parties-list">
                            <datalist id="parties-list"></datalist>
                        </div>
                        <div>
                            <select id="month">
                                <option value="" disabled selected>Select Month</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                        <div>
                            <input type="text" id="product" placeholder="Product" list="products-list">
                            <datalist id="products-list"></datalist>
                        </div>
                        <div>
                            <input type="number" id="target-value" placeholder="Target Value (in ₹)" step="0.01" min="0">
                        </div>
                    </div>
                    <button id="add-btn" class="btn btn-primary w-full mt-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Add Entry
                    </button>
                </div>

                <!-- Manage Data & Actions Card -->
                <div class="card">
                    <h2 class="text-lg sm:text-xl font-bold mb-4">Manage Data</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-2 gap-4">
                        <button id="import-btn" class="btn btn-secondary text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Import CSV
                        </button>
                        <button id="delete-party-btn" class="btn btn-secondary text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Delete Parties
                        </button>
                        <button id="delete-product-btn" class="btn btn-secondary text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Delete Products
                        </button>
                        <button id="download-btn" class="btn btn-secondary text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right column for dashboard and data -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Summary Dashboard Card -->
                <div class="card">
                    <h2 class="text-lg sm:text-xl font-bold mb-6">Summary Dashboard</h2>
                    
                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <p class="text-sm font-medium">Total Target Value</p>
                            <p id="total-target-value" class="text-2xl font-bold text-[color:var(--primary-color)] mt-1">₹0</p>
                            <p class="text-xs text-[color:var(--secondary-color)]">All entries</p>
                        </div>
                        
                        <div class="stat-card">
                            <p class="text-sm font-medium">Average Target</p>
                            <p id="average-target-value" class="text-2xl font-bold text-[color:var(--accent-color)] mt-1">₹0</p>
                            <p class="text-xs text-[color:var(--secondary-color)]">Per entry</p>
                        </div>
                        
                        <div class="stat-card">
                            <p class="text-sm font-medium">Total Entries</p>
                            <p id="total-entries" class="text-2xl font-bold text-[color:var(--success-color)] mt-1">0</p>
                            <p class="text-xs text-[color:var(--secondary-color)]">Records count</p>
                        </div>
                        
                        <div class="stat-card">
                            <p class="text-sm font-medium">Unique Parties</p>
                            <p id="unique-parties" class="text-2xl font-bold text-[color:var(--warning-color)] mt-1">0</p>
                            <p class="text-xs text-[color:var(--secondary-color)]">Active clients</p>
                        </div>
                    </div>
                    
                    <!-- Chart Section -->
                    <div class="mt-6">
                        <h3 class="text-md sm:text-lg font-bold mb-4">Performance Overview</h3>
                        <div class="chart-container">
                            <canvas id="sales-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div>
                            <h3 class="text-md sm:text-lg font-bold mb-4">Monthly Targets</h3>
                            <ul id="monthly-target-list" class="space-y-2"></ul>
                        </div>
                        
                        <div>
                            <h3 class="text-md sm:text-lg font-bold mb-4">Top Products</h3>
                            <div id="product-wise-target-list" class="space-y-4"></div>
                        </div>
                    </div>
                </div>

                <!-- Sales Data Table Card -->
                <div class="card">
                    <h2 class="text-lg sm:text-xl font-bold mb-6">Sales Data</h2>

                    <!-- Filter Chips -->
                    <div id="filter-chips" class="filter-chips"></div>

                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-4">
                        <input type="text" id="filter-party" placeholder="Filter by Party" list="parties-list" class="text-sm">
                        <select id="filter-month" class="text-sm">
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                        <input type="text" id="filter-product" placeholder="Filter by Product" list="products-list" class="text-sm">
                        <button id="clear-filters-btn" class="btn btn-secondary text-sm">Clear Filters</button>
                    </div>

                    <div id="data-table-container" class="data-table-container">
                        <table class="min-w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="p-3 text-xs sm:text-sm text-left">Party</th>
                                    <th class="p-3 text-xs sm:text-sm text-left">Month</th>
                                    <th class="p-3 text-xs sm:text-sm text-left">Product</th>
                                    <th class="p-3 text-xs sm:text-sm text-left">Target Value</th>
                                    <th class="p-3 text-xs sm:text-sm text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body" class="divide-y divide-[color:var(--border-color)]">
                                <!-- Data rows will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div id="message-box" class="mt-4 p-3 rounded-md text-sm hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reusable Modal for Deleting Parties/Products and User Manual -->
    <div id="app-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" id="modal-close-btn">&times;</button>
            <h3 id="modal-title" class="text-lg sm:text-xl font-bold mb-4"></h3>
            <div id="modal-body">
                <!-- Content will be dynamically injected here -->
            </div>
            <div id="modal-footer" class="flex justify-end space-x-2 mt-4">
                <!-- Buttons will be dynamically injected here -->
            </div>
        </div>
    </div>
    
    <!-- Hidden file input for CSV import -->
    <input type="file" id="csv-import-input" accept=".csv" class="hidden">

    <script>
        // JavaScript for the enhanced sales tracker application
        document.addEventListener('DOMContentLoaded', () => {
            // Data storage arrays and sets
            // Each entry will now have a unique ID for reliable editing/deletion.
            let salesData = [];
            let filteredSalesData = [];
            let partyNames = new Set();
            let productNames = new Set();
            
            // Chart instance
            let salesChart = null;
            
            // Get all necessary HTML elements
            const partyInput = document.getElementById('party');
            const monthInput = document.getElementById('month');
            const productInput = document.getElementById('product');
            const targetValueInput = document.getElementById('target-value');
            const addBtn = document.getElementById('add-btn');
            const dataTableBody = document.getElementById('data-table-body');
            const filterPartyInput = document.getElementById('filter-party');
            const filterMonthInput = document.getElementById('filter-month');
            const filterProductInput = document.getElementById('filter-product');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            const messageBox = document.getElementById('message-box');
            const totalTargetValueElement = document.getElementById('total-target-value');
            const averageTargetValueElement = document.getElementById('average-target-value');
            const totalEntriesElement = document.getElementById('total-entries');
            const uniquePartiesElement = document.getElementById('unique-parties');
            const monthlyTargetList = document.getElementById('monthly-target-list');
            const productWiseTargetList = document.getElementById('product-wise-target-list');
            const downloadBtn = document.getElementById('download-btn');
            const importBtn = document.getElementById('import-btn');
            const csvImportInput = document.getElementById('csv-import-input');
            const deletePartyBtn = document.getElementById('delete-party-btn');
            const deleteProductBtn = document.getElementById('delete-product-btn');
            const manualBtn = document.getElementById('manual-btn');
            const dummyDeleteBtn = document.getElementById('dummy-delete-btn');
            const filterChipsContainer = document.getElementById('filter-chips');
            
            // Modal elements
            const appModal = document.getElementById('app-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            
            /**
             * Shows a message in the message box for a short duration.
             * @param {string} message - The message to display.
             * @param {string} type - 'success', 'error', or 'info' to change color.
             */
            const showMessage = (message, type = 'info') => {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden');
                messageBox.classList.remove('bg-red-500', 'bg-green-500', 'bg-blue-500', 'bg-yellow-500', 'text-white');
                if (type === 'error') {
                    messageBox.classList.add('bg-red-500', 'text-white');
                } else if (type === 'success') {
                    messageBox.classList.add('bg-green-500', 'text-white');
                } else if (type === 'warning') {
                    messageBox.classList.add('bg-yellow-500', 'text-white');
                } else {
                    messageBox.classList.add('bg-blue-500', 'text-white');
                }
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000);
            };

            /**
             * Saves all app data (sales entries, parties, products) to localStorage.
             */
            const saveData = () => {
                try {
                    localStorage.setItem('salesData', JSON.stringify(salesData));
                    localStorage.setItem('partyNames', JSON.stringify(Array.from(partyNames)));
                    localStorage.setItem('productNames', JSON.stringify(Array.from(productNames)));
                } catch (e) {
                    console.error("Error saving data to localStorage:", e);
                    showMessage('Error saving data. Local storage might be full.', 'error');
                }
            };

            /**
             * Loads all app data from localStorage on page load.
             */
            const loadData = () => {
                try {
                    const storedSalesData = localStorage.getItem('salesData');
                    if (storedSalesData) {
                        salesData = JSON.parse(storedSalesData);
                    }

                    const storedPartyNames = localStorage.getItem('partyNames');
                    if (storedPartyNames) {
                        partyNames = new Set(JSON.parse(storedPartyNames));
                    }

                    const storedProductNames = localStorage.getItem('productNames');
                    if (storedProductNames) {
                        productNames = new Set(JSON.parse(storedProductNames));
                    }
                } catch (e) {
                    console.error("Error loading data from localStorage:", e);
                    salesData = [];
                    partyNames = new Set();
                    productNames = new Set();
                    showMessage('Error loading saved data. Starting with fresh data.', 'error');
                }
                
                // Set the default month filter to the current month
                const currentMonthIndex = new Date().getMonth();
                const monthOrder = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                filterMonthInput.value = monthOrder[currentMonthIndex];

                filterData();
                renderDatalists();
            };

            /**
             * Renders the sales data table based on the provided array.
             * Pagination has been removed to show all entries at once.
             * @param {Array<Object>} dataToRender - The array of data objects to display.
             */
            const renderTable = (dataToRender) => {
                dataTableBody.innerHTML = '';
                
                if (dataToRender.length === 0) {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="5" class="p-4 text-center text-sm italic opacity-75">No data found.</td>`;
                    dataTableBody.appendChild(noDataRow);
                    return;
                }
                
                dataToRender.forEach((entry, index) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-100 transition-colors duration-100';
                    // Use a data attribute with the unique ID for a reliable reference
                    row.innerHTML = `
                        <td class="p-3 text-xs sm:text-sm whitespace-nowrap">${entry.party}</td>
                        <td class="p-3 text-xs sm:text-sm whitespace-nowrap">${entry.month}</td>
                        <td class="p-3 text-xs sm:text-sm whitespace-nowrap">${entry.product}</td>
                        <td class="p-3 text-xs sm:text-sm whitespace-nowrap">₹${entry.targetValue.toLocaleString()}</td>
                        <td class="p-3 text-xs sm:text-sm whitespace-nowrap">
                            <button class="action-btn btn-warning edit-btn" data-id="${entry.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="action-btn btn-danger delete-btn" data-id="${entry.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </td>
                    `;
                    dataTableBody.appendChild(row);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        editEntry(id);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        deleteEntry(id);
                    });
                });
            };

            /**
             * Updates the summary dashboard with calculated totals.
             * @param {Array<Object>} dataToAnalyze - The array of data to analyze.
             */
            const updateDashboard = (dataToAnalyze) => {
                let totalTargetValue = 0;
                const monthlyTargets = {};
                const productWiseTargets = {};
                const uniquePartiesSet = new Set();

                dataToAnalyze.forEach(entry => {
                    const { party, month, product, targetValue } = entry;
                    
                    totalTargetValue += targetValue;
                    uniquePartiesSet.add(party);

                    if (!monthlyTargets[month]) {
                        monthlyTargets[month] = 0;
                    }
                    monthlyTargets[month] += targetValue;

                    if (!productWiseTargets[product]) {
                        productWiseTargets[product] = 0;
                    }
                    productWiseTargets[product] += targetValue;
                });
                
                // Update stats cards
                const totalInRupees = totalTargetValue.toLocaleString('en-IN', {
                    maximumFractionDigits: 0,
                    style: 'currency',
                    currency: 'INR'
                });
                totalTargetValueElement.textContent = totalInRupees;
                
                const averageTarget = dataToAnalyze.length > 0 ? totalTargetValue / dataToAnalyze.length : 0;
                const averageInRupees = averageTarget.toLocaleString('en-IN', {
                    maximumFractionDigits: 2,
                    style: 'currency',
                    currency: 'INR'
                });
                averageTargetValueElement.textContent = averageInRupees;
                
                totalEntriesElement.textContent = dataToAnalyze.length;
                uniquePartiesElement.textContent = uniquePartiesSet.size;
                
                // Update monthly targets list
                monthlyTargetList.innerHTML = '';
                const monthOrder = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                const sortedMonths = Object.keys(monthlyTargets).sort((a, b) => {
                    return monthOrder.indexOf(a) - monthOrder.indexOf(b);
                });
                
                sortedMonths.forEach(month => {
                    const total = monthlyTargets[month].toLocaleString('en-IN', {
                        maximumFractionDigits: 2, // Show fractional values
                        style: 'currency',
                        currency: 'INR'
                    });
                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center text-sm p-2 bg-[color:var(--bg-color)] rounded-md';
                    listItem.innerHTML = `
                        <span>${month}</span>
                        <span class="font-semibold text-[color:var(--accent-color)]">${total}</span>
                    `;
                    monthlyTargetList.appendChild(listItem);
                });

                // Update product-wise targets list (show top 5 only)
                productWiseTargetList.innerHTML = '';
                const sortedProducts = Object.entries(productWiseTargets)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                if (sortedProducts.length === 0) {
                    productWiseTargetList.innerHTML = '<p class="text-sm italic opacity-75 text-center">No product data</p>';
                } else {
                    sortedProducts.forEach(([product, total]) => {
                        const formattedTotal = total.toLocaleString('en-IN', {
                            maximumFractionDigits: 2, // Show fractional values as requested
                            style: 'currency',
                            currency: 'INR'
                        });
                        const productDiv = document.createElement('div');
                        productDiv.className = 'flex justify-between items-center text-sm p-2 bg-[color:var(--bg-color)] rounded-md';
                        productDiv.innerHTML = `
                            <span>${product}</span>
                            <span class="font-semibold text-[color:var(--success-color)]">${formattedTotal}</span>
                        `;
                        productWiseTargetList.appendChild(productDiv);
                    });
                }
                
                // Render the sales chart
                renderSalesChart(dataToAnalyze, monthlyTargets);
            };
            
            /**
             * Renders a sales chart with the provided data
             * @param {Array} data - The sales data to visualize
             * @param {Object} monthlyTargets - Monthly targets data
             */
            const renderSalesChart = (data, monthlyTargets) => {
                const ctx = document.getElementById('sales-chart').getContext('2d');
                
                // Destroy previous chart instance if it exists
                if (salesChart) {
                    salesChart.destroy();
                }
                
                if (!data || data.length === 0) {
                    // Show empty state if no data
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = "14px Inter";
                    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color');
                    ctx.textAlign = "center";
                    ctx.fillText("No data available for chart", ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }
                
                // Prepare data for chart
                const monthOrder = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                const labels = monthOrder.filter(month => monthlyTargets[month]);
                const dataValues = labels.map(month => monthlyTargets[month]);
                
                // Get colors based on current theme (now only light theme)
                const backgroundColor = 'rgba(79, 70, 229, 0.5)';
                const borderColor = 'rgb(79, 70, 229)';
                const textColor = '#1e293b';
                
                // Create new chart
                salesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Monthly Targets (₹)',
                            data: dataValues,
                            backgroundColor: backgroundColor,
                            borderColor: borderColor,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: textColor,
                                    callback: function(value) {
                                        if (value >= 1000000) {
                                            return '₹' + (value / 1000000).toFixed(1) + 'M';
                                        } else if (value >= 1000) {
                                            return '₹' + (value / 1000).toFixed(1) + 'K';
                                        }
                                        return '₹' + value;
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: textColor
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: textColor
                                }
                            }
                        }
                    }
                });
            };

            /**
             * Renders the datalists for Party and Product inputs.
             */
            const renderDatalists = () => {
                const partiesDatalist = document.getElementById('parties-list');
                partiesDatalist.innerHTML = '';
                Array.from(partyNames).sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    partiesDatalist.appendChild(option);
                });

                const productsDatalist = document.getElementById('products-list');
                productsDatalist.innerHTML = '';
                Array.from(productNames).sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    productsDatalist.appendChild(option);
                });
            };

            /**
             * Handles the logic for adding a new sales entry.
             */
            const addEntry = () => {
                const party = partyInput.value.trim();
                const month = monthInput.value;
                const product = productInput.value.trim();
                const targetValue = parseFloat(targetValueInput.value);

                if (!party || !month || !product || isNaN(targetValue) || targetValue <= 0) {
                    showMessage('Please fill out all fields with valid data. Target value must be a positive number.', 'error');
                    return;
                }

                // Create a unique ID for the new entry
                const newEntry = { id: crypto.randomUUID(), party, month, product, targetValue };
                salesData.push(newEntry);
                
                partyNames.add(party);
                productNames.add(product);

                saveData();
                renderDatalists();
                filterData();
                
                // Reset form
                partyInput.value = '';
                monthInput.value = '';
                productInput.value = '';
                targetValueInput.value = '';
                partyInput.focus();

                showMessage('Entry added successfully!', 'success');
            };
            
            /**
             * Edits an existing sales entry.
             * @param {string} id - The unique ID of the entry to edit.
             */
            const editEntry = (id) => {
                const entry = salesData.find(e => e.id === id);
                if (!entry) {
                    showMessage('Entry not found.', 'error');
                    return;
                }
                
                // Create edit form in modal
                let bodyContent = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Party Name</label>
                            <input type="text" id="edit-party" value="${entry.party}" list="parties-list" class="w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Month</label>
                            <select id="edit-month" class="w-full">
                                <option value="January" ${entry.month === 'January' ? 'selected' : ''}>January</option>
                                <option value="February" ${entry.month === 'February' ? 'selected' : ''}>February</option>
                                <option value="March" ${entry.month === 'March' ? 'selected' : ''}>March</option>
                                <option value="April" ${entry.month === 'April' ? 'selected' : ''}>April</option>
                                <option value="May" ${entry.month === 'May' ? 'selected' : ''}>May</option>
                                <option value="June" ${entry.month === 'June' ? 'selected' : ''}>June</option>
                                <option value="July" ${entry.month === 'July' ? 'selected' : ''}>July</option>
                                <option value="August" ${entry.month === 'August' ? 'selected' : ''}>August</option>
                                <option value="September" ${entry.month === 'September' ? 'selected' : ''}>September</option>
                                <option value="October" ${entry.month === 'October' ? 'selected' : ''}>October</option>
                                <option value="November" ${entry.month === 'November' ? 'selected' : ''}>November</option>
                                <option value="December" ${entry.month === 'December' ? 'selected' : ''}>December</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Product</label>
                            <input type="text" id="edit-product" value="${entry.product}" list="products-list" class="w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Target Value (₹)</label>
                            <input type="number" id="edit-target-value" value="${entry.targetValue}" step="0.01" min="0" class="w-full">
                        </div>
                    </div>
                `;
                
                const footerContent = `
                    <button id="cancel-edit-btn" class="btn btn-secondary">Cancel</button>
                    <button id="save-edit-btn" class="btn btn-primary">Save Changes</button>
                `;
                
                showAppModal('Edit Entry', bodyContent, footerContent);
                
                // Set up event listeners
                document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                    appModal.style.display = 'none';
                });
                
                document.getElementById('save-edit-btn').addEventListener('click', () => {
                    const party = document.getElementById('edit-party').value.trim();
                    const month = document.getElementById('edit-month').value;
                    const product = document.getElementById('edit-product').value.trim();
                    const targetValue = parseFloat(document.getElementById('edit-target-value').value);
                    
                    if (!party || !month || !product || isNaN(targetValue) || targetValue <= 0) {
                        showMessage('Please fill out all fields with valid data.', 'error');
                        return;
                    }
                    
                    // Find the original entry by its unique ID
                    const originalIndex = salesData.findIndex(item => item.id === id);
                    
                    if (originalIndex !== -1) {
                        salesData[originalIndex] = { id, party, month, product, targetValue };
                        
                        // Update party and product sets
                        partyNames.add(party);
                        productNames.add(product);
                        
                        saveData();
                        renderDatalists();
                        filterData();
                        appModal.style.display = 'none';
                        showMessage('Entry updated successfully!', 'success');
                    } else {
                        showMessage('Error: Could not find original entry to update.', 'error');
                    }
                });
            };
            
            /**
             * Deletes a sales entry after confirmation.
             * @param {string} id - The unique ID of the entry to delete.
             */
            const deleteEntry = (id) => {
                const entry = salesData.find(e => e.id === id);
                if (!entry) {
                    showMessage('Entry not found.', 'error');
                    return;
                }
                
                // Show confirmation modal
                let bodyContent = `
                    <p class="mb-4">Are you sure you want to delete this entry?</p>
                    <div class="bg-[color:var(--bg-color)] p-3 rounded-md">
                        <p><strong>Party:</strong> ${entry.party}</p>
                        <p><strong>Month:</strong> ${entry.month}</p>
                        <p><strong>Product:</strong> ${entry.product}</p>
                        <p><strong>Target Value:</strong> ₹${entry.targetValue.toLocaleString()}</p>
                    </div>
                `;
                
                const footerContent = `
                    <button id="cancel-delete-entry-btn" class="btn btn-secondary">Cancel</button>
                    <button id="confirm-delete-entry-btn" class="btn btn-danger">Delete</button>
                `;
                
                showAppModal('Confirm Deletion', bodyContent, footerContent);
                
                // Set up event listeners
                document.getElementById('cancel-delete-entry-btn').addEventListener('click', () => {
                    appModal.style.display = 'none';
                });
                
                document.getElementById('confirm-delete-entry-btn').addEventListener('click', () => {
                    // Find the original index in salesData by ID
                    const originalIndex = salesData.findIndex(item => item.id === id);
                    
                    if (originalIndex !== -1) {
                        salesData.splice(originalIndex, 1);
                        saveData();
                        filterData();
                        appModal.style.display = 'none';
                        showMessage('Entry deleted successfully!', 'success');
                    } else {
                        showMessage('Error: Could not find entry to delete.', 'error');
                    }
                });
            };

            /**
             * Filters the sales data based on user input.
             */
            const filterData = () => {
                const filterParty = filterPartyInput.value.trim().toLowerCase();
                const filterMonth = filterMonthInput.value;
                const filterProduct = filterProductInput.value.trim().toLowerCase();

                filteredSalesData = salesData.filter(entry => {
                    const matchesParty = !filterParty || entry.party.toLowerCase().includes(filterParty);
                    // The month filter now defaults to the current month, and does not have an "All Months" option
                    const matchesMonth = entry.month === filterMonth;
                    const matchesProduct = !filterProduct || entry.product.toLowerCase().includes(filterProduct);
                    return matchesParty && matchesMonth && matchesProduct;
                });
                
                renderTable(filteredSalesData);
                updateDashboard(filteredSalesData);
                updateFilterChips();
            };
            
            /**
             * Updates the filter chips display based on current filters.
             */
            const updateFilterChips = () => {
                filterChipsContainer.innerHTML = '';
                
                if (filterPartyInput.value) {
                    const chip = document.createElement('div');
                    chip.className = 'filter-chip';
                    chip.innerHTML = `
                        Party: ${filterPartyInput.value}
                        <button class="filter-chip-remove" data-type="party">&times;</button>
                    `;
                    filterChipsContainer.appendChild(chip);
                }
                
                if (filterMonthInput.value) {
                    const chip = document.createElement('div');
                    chip.className = 'filter-chip';
                    chip.innerHTML = `
                        Month: ${filterMonthInput.value}
                        <button class="filter-chip-remove" data-type="month">&times;</button>
                    `;
                    filterChipsContainer.appendChild(chip);
                }
                
                if (filterProductInput.value) {
                    const chip = document.createElement('div');
                    chip.className = 'filter-chip';
                    chip.innerHTML = `
                        Product: ${filterProductInput.value}
                        <button class="filter-chip-remove" data-type="product">&times;</button>
                    `;
                    filterChipsContainer.appendChild(chip);
                }
                
                // Add event listeners to remove buttons
                document.querySelectorAll('.filter-chip-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const type = e.target.getAttribute('data-type');
                        if (type === 'party') {
                            filterPartyInput.value = '';
                        } else if (type === 'month') {
                            // Revert to current month as default, since there is no 'All Months'
                            const currentMonthIndex = new Date().getMonth();
                            const monthOrder = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                            filterMonthInput.value = monthOrder[currentMonthIndex];
                        } else if (type === 'product') {
                            filterProductInput.value = '';
                        }
                        filterData();
                    });
                });
            };

            /**
             * Clears all filter inputs and re-renders the full table.
             */
            const clearFilters = () => {
                filterPartyInput.value = '';
                filterProductInput.value = '';
                
                // Reset month filter to current month as there is no "All Months" option
                const currentMonthIndex = new Date().getMonth();
                const monthOrder = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                filterMonthInput.value = monthOrder[currentMonthIndex];
                
                filterData();
                showMessage('Filters cleared.', 'info');
            };
            
            /**
             * Generates a CSV file from the current data and triggers a download.
             */
            const downloadCsv = () => {
                if (filteredSalesData.length === 0) {
                    showMessage('No data to download.', 'error');
                    return;
                }
                
                const headers = ["Party", "Month", "Product", "Target Value"];
                const csvRows = [headers.join(',')];
                
                filteredSalesData.forEach(entry => {
                    const values = [
                        `"${entry.party.replace(/"/g, '""')}"`,
                        `"${entry.month.replace(/"/g, '""')}"`,
                        `"${entry.product.replace(/"/g, '""')}"`,
                        entry.targetValue
                    ];
                    csvRows.push(values.join(','));
                });

                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                // Create filename with current date
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
                link.href = URL.createObjectURL(blob);
                link.download = `sales_data_${dateStr}.csv`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage('CSV file downloaded successfully!', 'success');
            };
            
            /**
             * Handles importing data from a CSV file.
             */
            const importCsv = () => {
                csvImportInput.click();
            };
            
            /**
             * Processes the selected CSV file for import.
             * @param {Event} e - The file input change event.
             */
            const processCsvImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const csvData = event.target.result;
                        const rows = csvData.split('\n');
                        const importedData = [];
                        
                        // Skip header row and process each data row
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i].trim();
                            if (!row) continue;
                            
                            // Handle quoted fields that might contain commas
                            const columns = [];
                            let inQuotes = false;
                            let currentValue = '';
                            
                            for (let j = 0; j < row.length; j++) {
                                const char = row[j];
                                
                                if (char === '"') {
                                    inQuotes = !inQuotes;
                                } else if (char === ',' && !inQuotes) {
                                    columns.push(currentValue);
                                    currentValue = '';
                                } else {
                                    currentValue += char;
                                }
                            }
                            
                            columns.push(currentValue);
                            
                            if (columns.length >= 4) {
                                const party = columns[0].replace(/^"|"$/g, '');
                                const month = columns[1].replace(/^"|"$/g, '');
                                const product = columns[2].replace(/^"|"$/g, '');
                                const targetValue = parseFloat(columns[3].replace(/^"|"$/g, ''));
                                
                                if (party && month && product && !isNaN(targetValue) && targetValue > 0) {
                                    // Add a unique ID to the imported entry
                                    importedData.push({ id: crypto.randomUUID(), party, month, product, targetValue });
                                    partyNames.add(party);
                                    productNames.add(product);
                                }
                            }
                        }
                        
                        if (importedData.length > 0) {
                            // Add imported data to existing data
                            salesData = [...salesData, ...importedData];
                            saveData();
                            renderDatalists();
                            filterData();
                            showMessage(`Successfully imported ${importedData.length} entries from CSV.`, 'success');
                        } else {
                            showMessage('No valid data found in the CSV file.', 'warning');
                        }
                    } catch (error) {
                        console.error('Error processing CSV:', error);
                        showMessage('Error processing CSV file. Please check the format.', 'error');
                    }
                    
                    // Reset the file input
                    e.target.value = '';
                };
                
                reader.readAsText(file);
            };
            
            /**
             * A reusable function to show a modal with dynamic content.
             * @param {string} title - The title of the modal.
             * @param {string} bodyContent - The HTML content for the modal's body.
             * @param {string} footerContent - The HTML content for the modal's footer.
             */
            const showAppModal = (title, bodyContent, footerContent) => {
                modalTitle.textContent = title;
                modalBody.innerHTML = bodyContent;
                modalFooter.innerHTML = footerContent;
                appModal.style.display = 'flex';
            };

            /**
             * Displays the modal to select items for deletion.
             * @param {string} type - 'party' or 'product'.
             */
            const showDeleteModal = (type) => {
                const list = type === 'party' ? partyNames : productNames;
                let bodyContent = '';
                
                if (list.size === 0) {
                    bodyContent = `<p class="italic opacity-75 text-center">No ${type === 'party' ? 'parties' : 'products'} to delete.</p>`;
                    const footerContent = `<button id="close-modal-btn" class="btn btn-secondary">Close</button>`;
                    showAppModal(`Delete ${type === 'party' ? 'Parties' : 'Products'}`, bodyContent, footerContent);
                    // Add event listener for the Close button
                    document.getElementById('close-modal-btn').addEventListener('click', () => appModal.style.display = 'none');
                    return;
                } 
                
                bodyContent = `
                    <p class="mb-3 text-sm">Select the ${type === 'party' ? 'parties' : 'products'} you want to delete. This will also remove all associated sales data.</p>
                    <div class="modal-item-list space-y-2">`;
                Array.from(list).sort().forEach(item => {
                    bodyContent += `
                        <label class="flex items-center space-x-2 p-2 hover:bg-[color:var(--bg-color)] rounded-md cursor-pointer transition-colors">
                            <input type="checkbox" value="${item}" data-item-type="${type}" class="form-checkbox h-4 w-4 rounded">
                            <span class="text-sm">${item}</span>
                        </label>
                    `;
                });
                bodyContent += `</div>`;
                
                const footerContent = `
                    <button id="cancel-delete-btn" class="btn btn-secondary">Cancel</button>
                    <button id="confirm-delete-btn" class="btn btn-danger">Delete Selected</button>
                `;
                showAppModal(`Delete ${type === 'party' ? 'Parties' : 'Products'}`, bodyContent, footerContent);
                
                // Attach event listeners for the delete modal buttons
                document.getElementById('confirm-delete-btn').addEventListener('click', () => confirmDelete(type));
                document.getElementById('cancel-delete-btn').addEventListener('click', () => appModal.style.display = 'none');
            };
            
            /**
             * Shows the confirmation modal for deleting all data.
             */
            const showDeleteAllModal = () => {
                const bodyContent = `<p class="mb-4">Are you absolutely sure you want to delete all saved data? This action cannot be undone.</p>`;
                const footerContent = `
                    <button id="cancel-delete-all-btn" class="btn btn-secondary">Cancel</button>
                    <button id="confirm-delete-all-btn" class="btn btn-danger">Delete All Data</button>
                `;
                showAppModal('Confirm Deletion', bodyContent, footerContent);
                
                document.getElementById('cancel-delete-all-btn').addEventListener('click', () => appModal.style.display = 'none');
                document.getElementById('confirm-delete-all-btn').addEventListener('click', () => {
                    localStorage.clear();
                    appModal.style.display = 'none';
                    showMessage('All data has been deleted. Reloading...', 'success');
                    setTimeout(() => location.reload(), 1500);
                });
            };

            /**
             * Handles the deletion of selected items from the lists and sales data.
             * @param {string} type - 'party' or 'product'.
             */
            const confirmDelete = (type) => {
                const checkboxes = modalBody.querySelectorAll('input[type="checkbox"]:checked');
                const itemsToDelete = Array.from(checkboxes).map(cb => cb.value);

                if (itemsToDelete.length === 0) {
                    appModal.style.display = 'none';
                    showMessage(`No ${type === 'party' ? 'parties' : 'products'} selected for deletion.`, 'warning');
                    return;
                }

                // Remove the items from the main sales data array
                salesData = salesData.filter(entry => {
                    const isPartyInList = type === 'party' && itemsToDelete.includes(entry.party);
                    const isProductInList = type === 'product' && itemsToDelete.includes(entry.product);
                    return !isPartyInList && !isProductInList;
                });

                // Remove the items from the Sets
                if (type === 'party') {
                    itemsToDelete.forEach(item => partyNames.delete(item));
                } else {
                    itemsToDelete.forEach(item => productNames.delete(item));
                }

                saveData();
                renderDatalists();
                filterData();
                appModal.style.display = 'none';
                showMessage(`${itemsToDelete.length} ${type === 'party' ? 'parties' : 'products'} deleted.`, 'success');
            };

            /**
             * Generates the HTML content for the user manual.
             * @returns {string} The HTML string for the manual.
             */
            const generateManualContent = () => {
                return `
                    <div class="manual-content space-y-4 text-sm">
                        <p class="italic opacity-80">Welcome to Sales Flow! This manual guides you through the application's features.</p>
                        
                        <h4>Adding a New Entry</h4>
                        <p>Fill in the fields to add a new sales record:</p>
                        <ul class="list-disc list-inside space-y-1 ml-4">
                            <li><strong>Party Name:</strong> The client or party name.</li>
                            <li><strong>Month:</strong> The target month.</li>
                            <li><strong>Product:</strong> The specific product.</li>
                            <li><strong>Target Value:</strong> The target sales value in ₹.</li>
                        </ul>
                        <p>Click "Add Entry" to save the record.</p>

                        <h4>Managing Data</h4>
                        <p>Use these buttons to manage your data:</p>
                        <ul class="list-disc list-inside space-y-1 ml-4">
                            <li><strong>Import CSV:</strong> Import data from a CSV file.</li>
                            <li><strong>Delete Parties/Products:</strong> Remove names and all associated sales data.</li>
                            <li><strong>Download CSV:</strong> Export the current table data to a CSV file.</li>
                        </ul>
                        <p class="mt-4">
                            To **Delete All Data**, click the "Reset Data" button at the top right of the header. A confirmation window will appear to prevent accidental deletion.
                        </p>

                        <h4>Summary Dashboard</h4>
                        <p>Get a quick overview of your sales performance:</p>
                        <ul class="list-disc list-inside space-y-1 ml-4">
                            <li><strong>Total Target Value:</strong> Sum of all filtered targets.</li>
                            <li><strong>Average Target:</strong> Average target value per entry.</li>
                            <li><strong>Total Entries:</strong> Count of all records.</li>
                            <li><strong>Unique Parties:</strong> Number of distinct clients.</li>
                            <li><strong>Performance Chart:</strong> Visual representation of monthly targets.</li>
                            <li><strong>Monthly Targets:</strong> Breakdown of targets by month.</li>
                            <li><strong>Top Products:</strong> Top 5 products by target value, including fractions.</li>
                        </ul>

                        <h4>Data Table</h4>
                        <p>View and manage all your sales data:</p>
                        <ul class="list-disc list-inside space-y-1 ml-4">
                            <li>Use the filter inputs to find specific data.</li>
                            <li>The month filter automatically shows data for the current month.</li>
                            <li>Active filters are shown as chips that can be removed.</li>
                            <li>Use the action buttons to edit or delete entries.</li>
                            <li>All entries for the selected month are shown on one page.</li>
                        </ul>
                    </div>
                `;
            };

            /**
             * Displays the user manual modal.
             */
            const showManualModal = () => {
                const manualContent = generateManualContent();
                const footerContent = `<button id="close-modal-btn" class="btn btn-secondary">Close</button>`;
                showAppModal('User Manual', manualContent, footerContent);
                // Add event listener for the Close button inside the manual modal
                document.getElementById('close-modal-btn').addEventListener('click', () => appModal.style.display = 'none');
            };
            
            // Event listeners
            addBtn.addEventListener('click', addEntry);
            
            // Filters now trigger a full data re-render
            filterPartyInput.addEventListener('input', filterData);
            filterMonthInput.addEventListener('change', filterData);
            filterProductInput.addEventListener('input', filterData);
            
            clearFiltersBtn.addEventListener('click', clearFilters);
            downloadBtn.addEventListener('click', downloadCsv);
            importBtn.addEventListener('click', importCsv);
            csvImportInput.addEventListener('change', processCsvImport);
            deletePartyBtn.addEventListener('click', () => showDeleteModal('party'));
            deleteProductBtn.addEventListener('click', () => showDeleteModal('product'));
            manualBtn.addEventListener('click', showManualModal);
            modalCloseBtn.addEventListener('click', () => appModal.style.display = 'none');
            
            // Dummy button to trigger the "Delete All" confirmation modal
            dummyDeleteBtn.addEventListener('click', showDeleteAllModal);
            
            // Close modal when clicking outside
            appModal.addEventListener('click', (e) => {
                if (e.target === appModal) {
                    appModal.style.display = 'none';
                }
            });
            
            // Allow submitting form with Enter key
            partyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addEntry();
            });
            
            monthInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addEntry();
            });
            
            productInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addEntry();
            });
            
            targetValueInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addEntry();
            });
            
            // Initial load of data from localStorage
            loadData();
        });
    </script>
</body>
</html>